

module load cdo


targetgrid=/p/projects/pism/mengel/pism_input/cdo_remapgrids/initmip_8km.nc

mkdir -v {{target_path}}/sellevel
mkdir -v {{target_path}}/vertmean
mkdir -v {{target_path}}/remap
mkdir -v {{target_path}}/concat

## loop area


{% for file in cmip_files %}

cdo sellevel,{{zlevelstring}} {{source_path}}/{{file}} {{target_path}}/sellevel/{{file}}
cdo vertmean {{target_path}}/sellevel/{{file}} {{target_path}}/vertmean/{{file}}

cdo -b F64 -f nc4c remapbil,$targetgrid {{target_path}}/vertmean/{{file}} {{target_path}}/remap/{{file}}

{% endfor %}


## merge all files

cd {{target_path}}/remap && cdo -b F64 -f nc4c mergetime {{cmipfilesstring}} {{target_path}}/concat/{{runid}}.nc